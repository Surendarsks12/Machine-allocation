<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Production Allocation</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
  <div class="max-w-4xl mx-auto bg-white p-6 rounded shadow-lg">
    <h1 class="text-3xl font-bold text-center mb-6">‚öôÔ∏è Production Allocation</h1>

    <!-- Start Date -->
    <div class="mb-4">
      <label class="font-semibold block mb-1">Start Date:</label>
      <input id="startDate" type="date" class="border p-2 rounded w-64" />
    </div>

    <!-- Component Entry -->
    <div class="mb-6">
      <label class="font-semibold block mb-1">Enter Component IDs (comma separated):</label>
      <input id="componentIds" type="text" placeholder="11101, 11102" class="border p-2 rounded w-full" />
    </div>

    <!-- Allocate Button -->
    <div class="mb-6">
      <button onclick="allocate()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">üöÄ Allocate</button>
    </div>

    <!-- Output Table -->
    <div>
      <h2 class="text-xl font-bold mb-2">üìÑ Allocation Result:</h2>
      <table class="min-w-full border text-sm" id="resultTable">
        <thead>
          <tr class="bg-gray-200">
            <th class="border px-4 py-2">Component ID</th>
            <th class="border px-4 py-2">Operation</th>
            <th class="border px-4 py-2">Machine</th>
            <th class="border px-4 py-2">Date</th>
            <th class="border px-4 py-2">Cost/hr</th>
          </tr>
        </thead>
        <tbody id="resultBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const SHEET_API = "https://script.google.com/macros/s/AKfycby8hy_NO6eQciLwuiZfG3eGFdr4oDMQ84EwAtu3VX6I3_gpJYtBG4epChWsKkJcqskg_A/exec"; // Replace with your deployed script URL

    async function fetchData() {
      const res = await fetch(SHEET_API);
      return await res.json();
    }

    function getDateAfter(start, days) {
      const date = new Date(start);
      date.setDate(date.getDate() + days);
      return date.toISOString().split("T")[0];
    }

    function allocate() {
      const compInput = document.getElementById("componentIds").value.trim();
      const startDate = document.getElementById("startDate").value;
      const resultBody = document.getElementById("resultBody");
      resultBody.innerHTML = "";

      if (!compInput || !startDate) {
        alert("Please fill all fields.");
        return;
      }

      const compIds = compInput.split(",").map(c => c.trim());
      fetchData().then(data => {
        let dayCounter = 0;

        compIds.forEach(cid => {
          const ops = data.filter(row => row["Component ID"] == cid);
          ops.sort((a, b) => a["operations"] - b["operations"]);

          ops.forEach(op => {
            const machines = ["T1", "T2", "T3", "T4", "V1", "V2"];
            let best = null;
            machines.forEach(m => {
              if (op[m] == "1") {
                const cost = Number(op[`cost_${m}`]);
                if (!best || cost < best.cost) {
                  best = { machine: m, cost };
                }
              }
            });

            const row = document.createElement("tr");
            row.innerHTML = `
              <td class="border px-4 py-2">${cid}</td>
              <td class="border px-4 py-2">${op["operations"]}</td>
              <td class="border px-4 py-2">${best?.machine || "-"}</td>
              <td class="border px-4 py-2">${getDateAfter(startDate, dayCounter)}</td>
              <td class="border px-4 py-2">${best?.cost || "-"}</td>
            `;
            resultBody.appendChild(row);
            dayCounter += 1;
          });
        });
      });
    }
  </script>
</body>
</html>
